name: Sync to Hugging Face Space + Discord

on:
  push:
    branches: ["main"]        # change to ["**"] if you want all branches
  workflow_dispatch: {}        # allows manual runs from the Actions tab

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate secrets (no values shown)
        run: |
          test -n "${{ secrets.HF_TOKEN }}" && echo "HF_TOKEN: OK" || (echo "HF_TOKEN MISSING"; exit 1)
          test -n "${{ secrets.HF_SPACE_ID }}" && echo "HF_SPACE_ID: OK" || (echo "HF_SPACE_ID MISSING"; exit 1)
          if [ -z "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "WARNING: DISCORD_WEBHOOK_URL not set - Discord notify will be skipped."
          else
            echo "DISCORD_WEBHOOK_URL: OK"
          fi

      # ------------------ Discord: START message ------------------
      - name: Discord start
        if: ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          curl -sS -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"ðŸš€ Starting deploy for **$GITHUB_REPOSITORY** (run #$GITHUB_RUN_NUMBER) by **$GITHUB_ACTOR**\"}" \
            "$DISCORD_WEBHOOK_URL"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install huggingface_hub
        run: pip install --upgrade huggingface_hub

      - name: Upload to Hugging Face Space
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
        run: |
          python - <<'PY'
          import os
          from huggingface_hub import HfApi
          api = HfApi(token=os.environ["HF_TOKEN"])
          api.upload_folder(
              folder_path=".",
              repo_id=os.environ["HF_SPACE_ID"],   # e.g., nehabathuri/Image-to-Story
              repo_type="space",
              ignore_patterns=[
                  ".git*", ".github*", "__pycache__*", "*.pyc",
                  "models/*", "data/*", "*.pt", "*.bin"
              ],
          )
          print("âœ… Upload complete.")
          PY

      # ------------------ Discord: END message ------------------
      - name: Discord finish
        if: always() && ${{ secrets.DISCORD_WEBHOOK_URL != '' }}
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            STATUS="âœ… Success"
          else
            STATUS="âŒ Failed"
          fi
          MSG="$(cat <<EOF
$STATUS â€“ deploy for **$GITHUB_REPOSITORY**
â€¢ Actor: $GITHUB_ACTOR
â€¢ Run: #$GITHUB_RUN_NUMBER
â€¢ Logs: https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID
â€¢ Space: https://huggingface.co/spaces/$HF_SPACE_ID
â€¢ Live App: https://nehabathuri-image-to-story.hf.space
EOF
)"
          # Escape newlines for JSON
          JSON_PAYLOAD=$(python - <<'PY'
import json, os
print(json.dumps({"content": os.environ["MSG"]}))
PY
)
          curl -sS -X POST -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            "$DISCORD_WEBHOOK_URL"
